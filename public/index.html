<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>FFVB-Calendar</title>
    <script src="../scripts/form.js" type="application/javascript"></script>
    <link rel="stylesheet" href="../styles/form.css">
    <!-- inspired from https://codepen.io/ainalem/pen/GRqPwoz by Mikael Ainalem -->
</head>
<body id="body" class="preload">
<div class="form">
    <div class="title">Calendrier ICS</div>
    <div class="subtitle">Générer un calendrier au format ICS</div>
    <form id="formICS" action="/api/calendar/ics" method="GET">
        <div class="input-container ic1">
            <input required id="saison" class="input" type="text" placeholder=" " name="saison"/>
            <div class="cut"></div>
            <label for="saison" class="placeholder">Saison</label>
        </div>
        <div class="input-container ic2">
            <input required id="codent" class="input" type="text" placeholder=" " name="codent"/>
            <div class="cut"></div>
            <label for="codent" class="placeholder">Codent</label>
        </div>
        <div class="input-container ic2">
            <input required id="poule" class="input" type="text" placeholder=" " name="poule"/>
            <div class="cut"></div>
            <label for="poule" class="placeholder">Poule</label>
        </div>
        <div class="input-container ic2">
            <input required id="team" class="input" type="text" placeholder=" " name="team"/>
            <div class="cut"></div>
            <label for="team" class="placeholder">Equipe</label>
        </div>
        <button type="submit" class="submit">Génerer</button>
        <div class="errorDiv hide">
            <p></p>
        </div>
    </form>
    <div class="help">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="darkgrey" class="bi bi-question-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
        </svg>
        Les informations nécessaires peuvent être trouvées dans l'URL du calendrier du site FFVB officiel <br>
        Exemple: https://www.ffvbbeach.org/ffvbapp/resu/vbspo_calendrier.php?saison=<span>20XX/20XX</span>&codent=<span>XXXX</span>&poule=<span>XXX</span>
    </div>

</div>
</body>
<style type="text/css">
    body {
        align-items: center;
        background-color: #000;
        display: flex;
        justify-content: center;
        font-family: sans-serif;
    }

    .form {
        display: block;
        background-color: #15172b;
        border-radius: 20px;
        box-sizing: border-box;
        padding: 20px;
        width: 320px;
        transition: height 400ms ease-out;
    }

    .title {
        color: whitesmoke;
        font-size: 36px;
        font-weight: 600;
    }

    .subtitle {
        color: dimgrey;
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
    }

    #formICS{
        display: grid;
    }

    .input-container {
        height: 50px;
        position: relative;
        width: 100%;
    }

    .ic1 {
        margin-top: 40px;
    }

    .ic2 {
        margin-top: 30px;
    }

    .input {
        background-color: #303245;
        border-radius: 12px;
        border: 0;
        box-sizing: border-box;
        color: #eee;
        font-size: 18px;
        height: 100%;
        outline: 0;
        padding: 4px 20px 0;
        width: 100%;
    }

    .cut {
        background-color: #15172b;
        border-radius: 10px;
        height: 20px;
        left: 20px;
        position: absolute;
        top: -20px;
        transform: translateY(0);
        transition: transform 200ms;
        width: 76px;
    }

    .input:focus ~ .cut, .input:hover ~ .cut,
    .input:not(:placeholder-shown) ~ .cut {
        transform: translateY(8px);
    }

    .placeholder {
        color: #65657b;
        left: 20px;
        line-height: 14px;
        pointer-events: none;
        position: absolute;
        transform-origin: 0 50%;
        transition: transform 200ms, color 200ms;
        top: 20px;
    }

    .input:focus ~ .placeholder, .input:hover ~ .placeholder,
    .input:not(:placeholder-shown) ~ .placeholder {
        transform: translateY(-30px) translateX(10px) scale(0.75);
    }

    .input:not(:placeholder-shown) ~ .placeholder {
        color: #808097;
    }

    .input:focus ~ .placeholder, .input:hover ~ .placeholder {
        color: #dc2f55;
    }

    .submit {
        background-color: #08d;
        transition: background-color 200ms ease-out;
        border-radius: 12px;
        border: 0;
        box-sizing: border-box;
        color: #eee;
        cursor: pointer;
        font-size: 18px;
        height: 50px;
        margin-top: 30px;
        text-align: center;
        width: 100%;
    }

    .submit:hover {
        background-color: #06b;
    }

    .submit:active {
        top: 1px;
    }

    .preload * {
        -webkit-transition: none !important;
        -moz-transition: none !important;
        -ms-transition: none !important;
        -o-transition: none !important;
    }

    #ffvbLink{
        padding: 10px 0 10px 0;
    }

    .errorDiv {
        background-color: firebrick;
        border-radius: 12px;
        opacity: 1;
        transition: transform 400ms ease, opacity 600ms linear;
        text-align: center;
        margin-top: 20px;
        display: flex;
        color: whitesmoke;
        padding: 0 20px 0;
    }

    .hide{
        visibility: hidden;
        position: absolute;
    }



    .hide.errorDiv {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-200px);
        position: absolute;
    }

    div.show.errorDiv {
        opacity: 1;
        visibility: visible;
        transform: translateY(0px);
        position: inherit;
    }

    .help{
        padding-top: 10px;
        font-style: italic;
        color: darkgrey;
        font-size: 14px;
        word-wrap:break-word;
    }
    .help > span{
        color: dimgray;
    }
</style>
<script type="text/javascript">
    window.onload = () => {
        document.getElementById("body").removeAttribute("class")
        document.getElementById("formICS").addEventListener("submit", submitFormICS)
    };

    const submitFormICS = (event) => {
        event.preventDefault()
        try { // if error div is showing
            let errorDiv = document.querySelector("#formICS .errorDiv")
            errorDiv.classList.remove("show");
        } catch (e) {
        }

        const formData = new FormData(event.target); // Récupère les données du formulaire
        const urlReq = `${event.target.action}?${new URLSearchParams(formData).toString()}`; // Ajoute les paramètres GET à l'URL
        let filename = "file.ics"

        fetch(urlReq)
            .then(async response => {
                if (!response.ok) {
                    let resJson = await response.json()
                    throw new Error(resJson.message);
                }
                const disposition = response.headers.get("content-disposition");
                const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                const matches = filenameRegex.exec(disposition);
                filename = matches != null && matches[1] ? matches[1].replace(/['"]/g, '') : filename; // Si le nom de fichier n'est pas présent dans la réponse, utilisez un nom de fichier par défaut.
                const contentType = response.headers.get("content-type");
                if (contentType.includes("application/json")) {
                    return response.json();
                } else {
                    return response.blob();
                }
            })
            .then(data => {
                if (data instanceof Blob) {
                    // Traitement du fichier
                    const downloadLink = document.createElement("a");
                    downloadLink.href = URL.createObjectURL(data);
                    downloadLink.download = filename;
                    downloadLink.click();
                } else {
                    // Traitement du JSON
                    console.log("Données reçues :", data);
                }
            }).catch(error => {
            let form = document.querySelector("#formICS")
            let errorDiv = form.querySelector(".errorDiv")

            errorDiv.querySelector("p").innerText = error.message
            errorDiv.classList.add("show");

            console.error(`${error.message}`);
        });
    };
</script>
</html>

